<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Solver V20 (Fixed)</title>
    <style>
        :root {
            /* È†êË®≠ËÆäÊï∏ (Pro Dark) */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #4a90e2; 
            
            --cell-def: #333333;
            --obs-color: #4a90e2; 
            --in-color: #00d2d3;
            
            --s1: #ff6b6b; --s2: #feca57; --s3: #48dbfb;
            --btn-grad: linear-gradient(135deg, #4a90e2, #00d2d3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            min-height: 100vh;
            transition: background 0.4s ease, color 0.4s ease;
        }

        /* --- ÁôªÂÖ•È†Å --- */
        #landingPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; transition: opacity 0.4s;
        }
        .logo-text { font-size: 2rem; font-weight: bold; margin-bottom: 50px; letter-spacing: 3px; text-transform: uppercase; text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        
        .theme-selector { display: flex; gap: 30px; margin-bottom: 60px; }
        .theme-dot {
            width: 55px; height: 55px; border-radius: 50%;
            cursor: pointer; border: 2px solid transparent;
            position: relative; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .theme-dot.selected { border-color: var(--text-main); transform: scale(1.2); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .theme-dot::after { 
            content: attr(data-name); position: absolute; bottom: -30px; left: 50%; 
            transform: translateX(-50%); font-size: 0.85rem; color: var(--text-sub); white-space: nowrap; font-weight: bold;
        }

        .start-btn {
            background-color: var(--text-main); color: var(--bg-color);
            border: none; padding: 14px 45px; border-radius: 50px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            letter-spacing: 1px; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .start-btn:active { transform: scale(0.95); }

        /* --- ÊïôÂ≠∏ÂΩàÁ™ó --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 3000; display: none; 
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal-content {
            background: var(--card-bg); width: 100%; max-width: 320px;
            border-radius: 20px; padding: 30px; text-align: center;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 25px; color: var(--text-main); }
        .step-list { text-align: left; font-size: 0.95rem; color: var(--text-sub); line-height: 2.2; margin-bottom: 30px; padding-left: 15px; list-style: none;}
        .highlight { color: var(--accent); font-weight: bold; }
        .modal-btn { 
            background: var(--accent); color: #fff; border: none; 
            padding: 12px 0; border-radius: 12px; font-weight: bold; 
            cursor: pointer; width: 100%; font-size: 1rem;
        }

        /* --- ‰∏ª‰ªãÈù¢ --- */
        .container {
            display: none; flex-direction: column; gap: 15px;
            max-width: 600px; margin: 0 auto;
            padding: 15px; padding-bottom: 100px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: background 0.3s;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .title { font-size: 1rem; font-weight: bold; color: var(--text-main); opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;}
        
        .btn-toggle { 
            background: none; border: none; color: var(--text-sub); 
            font-size: 1rem; cursor: pointer; transition: transform 0.3s; padding: 5px;
        }
        .btn-toggle.rotated { transform: rotate(-90deg); }

        /* Á∂≤Ê†º */
        .grid-frame {
            display: grid; gap: 3px;
            background-color: rgba(128,128,128,0.1);
            border: 2px solid rgba(128,128,128,0.1);
            border-radius: 8px; margin: 0 auto;
            touch-action: none;
        }
        .cell {
            background-color: var(--cell-def);
            border-radius: 4px; cursor: pointer;
            transition: background-color 0.1s;
        }
        .c-obs { background-color: var(--obs-color); }
        .c-in { background-color: var(--in-color); box-shadow: 0 0 8px var(--in-color); }
        .c-s1 { background-color: var(--s1); }
        .c-s2 { background-color: var(--s2); }
        .c-s3 { background-color: var(--s3); }

        #mainBoard { grid-template-columns: repeat(8, 1fr); width: 100%; max-width: 300px; aspect-ratio: 1; transition: all 0.3s; }
        .collapsed-board { display: none; }

        .hand-section { display: flex; justify-content: center; gap: 10px; }
        .hand-wrapper { display: flex; flex-direction: column; align-items: center; }
        .mini-grid { grid-template-columns: repeat(5, 1fr); width: 130px; height: 130px; border-radius: 8px;}
        .counter { font-size: 0.75rem; color: var(--text-sub); margin-top: 5px; }

        /* Â∫ïÈÉ®ÊåâÈàï */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--card-bg);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding: 10px 20px;
            display: flex; gap: 15px; z-index: 100;
        }
        @media (min-width: 600px) { .action-bar { justify-content: center; } .action-bar button { max-width: 200px; } }

        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; color: #fff; transition: transform 0.1s; }
        .btn:active { transform: scale(0.96); }
        .btn-reset { background: transparent; border: 1px solid var(--text-sub); color: var(--text-sub); }
        .btn-calc { background-color: var(--text-main); color: var(--bg-color); }
        .btn-next { 
            background: var(--btn-grad); color: #fff;
            width: 100%; margin-top: 20px; padding: 15px; 
            font-size: 1.1rem; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* ÁµêÊûúÂçÄ */
        #resultArea { display: none; margin-top: 20px; border-top: 1px solid rgba(128,128,128,0.2); padding-top: 20px; }
        .result-title { text-align: center; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; color: var(--text-main); }
        .steps-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .step-box { text-align: center; }
        .step-tag { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; }
        .step-grid { grid-template-columns: repeat(8, 1fr); width: 150px; height: 150px; pointer-events: none; }

        #msg { text-align: center; font-weight: bold; min-height: 24px; margin-top: 10px; color: var(--s2); font-size: 0.9rem;}
        .perfect-badge { background: linear-gradient(45deg, #ff0055, #ffaa00); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px; box-shadow: 0 0 10px rgba(255,170,0,0.4); }

        /* --- Êá∏ÊµÆÊåâÈàï (Magic Toggle) --- */
        .theme-fab {
            position: fixed; bottom: 85px; right: 20px;
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 101;
            font-size: 1.5rem;
            color: var(--text-main);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .theme-fab:hover { transform: translateY(-2px); border-color: var(--accent); color: var(--accent); box-shadow: 0 8px 32px rgba(74, 144, 226, 0.3); }
        .theme-fab:active { transform: scale(0.95); }
        
        .theme-menu {
            position: fixed; bottom: 145px; right: 20px;
            background: rgba(20,20,20,0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 8px; border-radius: 16px;
            display: none; flex-direction: column; gap: 5px;
            z-index: 102;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            min-width: 130px;
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .theme-opt {
            padding: 12px 15px; border-radius: 10px; cursor: pointer;
            color: #ccc; font-size: 0.9rem; display: flex; align-items: center; gap: 12px;
            transition: background 0.2s; font-weight: 500;
        }
        .theme-opt:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .color-preview { width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); }

    </style>
</head>
<body>

    <div id="landingPage">
        <div class="logo-text">BLOCK SOLVER</div>
        <div class="theme-selector">
            <div class="theme-dot selected" style="background:#252525" data-name="Â∞àÊ•≠Èªë" onclick="setLandingTheme('dark', this)"></div>
            <div class="theme-dot" style="background:#fff0f5" data-name="Ê´ªËä±Á≤â" onclick="setLandingTheme('light', this)"></div>
            <div class="theme-dot" style="background:#000; border:1px solid #d4af37" data-name="ÈªëÈáë" onclick="setLandingTheme('gold', this)"></div>
        </div>
        <button class="start-btn" onclick="enterApp()">START</button>
    </div>

    <div class="modal-overlay" id="tutorialModal">
        <div class="modal-content">
            <div class="modal-title">üìù Êà∞Áï•ÊåáÂçó</div>
            <ul class="step-list">
                <li>1. Ê®ôË®ò‰∏äÊñπ <span class="highlight">ÁèæÊúâÈöúÁ§ô</span></li>
                <li>2. Áï´Âá∫‰∏ãÊñπ <span class="highlight">‰∏âÂºµÊâãÁâå</span></li>
                <li>3. ÈªûÊìä <span class="highlight">ÈñãÂßãË®àÁÆó</span></li>
                <li>4. Á®ãÂºèÊúÉÂÑ™ÂÖàÂ∞ãÊâæ <span class="highlight">ÂÖ®Ëû¢ÂπïÊ∏ÖÁ©∫</span> ÁöÑËß£Ê≥ï</li>
            </ul>
            <button class="modal-btn" onclick="closeTutorial()">ÈñãÂßã‰ΩøÁî®</button>
        </div>
    </div>

    <div class="container" id="app">
        <div class="theme-fab" onclick="toggleMenu()">‚ú®</div>
        <div class="theme-menu" id="themeMenu">
            <div class="theme-opt" onclick="applyTheme('dark')"><div class="color-preview" style="background:#1a1a1a"></div> Dark</div>
            <div class="theme-opt" onclick="applyTheme('light')"><div class="color-preview" style="background:#ffb7b2"></div> Sakura</div>
            <div class="theme-opt" onclick="applyTheme('gold')"><div class="color-preview" style="background:#d4af37"></div> Gold</div>
        </div>

        <div class="card">
            <div class="header">
                <span class="title">Áõ§Èù¢ (Board)</span>
                <button class="btn-toggle" id="toggleBtn" onclick="toggleBoard()">‚ñº</button>
            </div>
            <div id="boardContainer">
                <div id="mainBoard" class="grid-frame"></div>
            </div>
        </div>

        <div class="card">
            <div class="header">
                <span class="title">ÊâãÁâå (Hand)</span>
            </div>
            <div class="hand-section">
                <div class="hand-wrapper">
                    <div id="input1" class="grid-frame mini-grid" data-group="1"></div>
                </div>
                <div class="hand-wrapper">
                    <div id="input2" class="grid-frame mini-grid" data-group="2"></div>
                </div>
                <div class="hand-wrapper">
                    <div id="input3" class="grid-frame mini-grid" data-group="3"></div>
                </div>
            </div>
            <div id="msg"></div>
            <div id="resultArea">
                <div class="result-title" id="resTitle">ÊúÄ‰Ω≥Á≠ñÁï•</div>
                <div class="steps-container">
                    <div class="step-box">
                        <div class="step-tag" style="color:var(--s1)" id="tag1">1</div>
                        <div id="res1" class="grid-frame step-grid"></div>
                    </div>
                    <div class="step-box">
                        <div class="step-tag" style="color:var(--s2)" id="tag2">2</div>
                        <div id="res2" class="grid-frame step-grid"></div>
                    </div>
                    <div class="step-box">
                        <div class="step-tag" style="color:var(--s3)" id="tag3">3</div>
                        <div id="res3" class="grid-frame step-grid"></div>
                    </div>
                </div>
                <button class="btn btn-next" onclick="continueGame()">‚¨áÔ∏è Â•óÁî®‰∏¶ÈñãÂßã‰∏ã‰∏ÄÂ±Ä</button>
            </div>
        </div>
    </div>

    <div class="action-bar" id="actionBar">
        <button class="btn btn-reset" onclick="resetAll()">Ê∏ÖÁ©∫ÈáçÁΩÆ</button>
        <button class="btn btn-calc" onclick="calculate()">ÈñãÂßãË®àÁÆó</button>
    </div>

<script>
    // --- ‰∏ªÈ°å ---
    const themes = {
        dark: { 
            '--bg-color': '#1a1a1a', '--card-bg': '#252525', '--text-main': '#e0e0e0', '--text-sub': '#a0a0a0', 
            '--accent': '#4a90e2', '--cell-def': '#333', '--obs-color': '#4a90e2', '--in-color': '#00d2d3',
            '--btn-grad': 'linear-gradient(135deg, #4a90e2, #00d2d3)'
        },
        light: { 
            '--bg-color': '#fff0f5', '--card-bg': '#ffffff', '--text-main': '#5d4037', '--text-sub': '#8d6e63', 
            '--accent': '#ff80ab', '--cell-def': '#fce4ec', '--obs-color': '#ffb7b2', '--in-color': '#ff4081',
            '--btn-grad': 'linear-gradient(135deg, #ff80ab, #ff4081)'
        },
        gold: { 
            '--bg-color': '#000000', '--card-bg': '#111111', '--text-main': '#d4af37', '--text-sub': '#888', 
            '--accent': '#d4af37', '--cell-def': '#222', '--obs-color': '#d4af37', '--in-color': '#fff',
            '--btn-grad': 'linear-gradient(135deg, #d4af37, #fefefe)'
        }
    };

    function setLandingTheme(name, el) {
        document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        applyTheme(name);
    }
    function applyTheme(name) {
        const t = themes[name];
        const root = document.documentElement;
        for (const [k, v] of Object.entries(t)) root.style.setProperty(k, v);
        document.getElementById('themeMenu').style.display = 'none';
    }
    function toggleMenu() {
        const m = document.getElementById('themeMenu');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    // --- ÊµÅÁ®ã ---
    function enterApp() {
        document.getElementById('landingPage').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('tutorialModal').style.display = 'flex';
        }, 400);
    }
    function closeTutorial() { document.getElementById('tutorialModal').style.display = 'none'; }
    function toggleBoard() {
        const board = document.getElementById('mainBoard');
        const btn = document.getElementById('toggleBtn');
        if (board.classList.contains('collapsed-board')) {
            board.classList.remove('collapsed-board'); btn.classList.remove('rotated');
        } else {
            board.classList.add('collapsed-board'); btn.classList.add('rotated');
        }
    }

    // --- Ê†∏ÂøÉÈÇèËºØ (Bug Fix: Á∂ÅÂÆöËàáÊ∏≤ÊüìÂàÜÈõ¢) ---
    let isDrawing = false, paintMode = true, currentDrawingId = null, finalBoardState = null;

    // 1. Á∂ÅÂÆö‰∫ã‰ª∂ (Âè™Âü∑Ë°å‰∏ÄÊ¨°)
    ['mainBoard', 'input1', 'input2', 'input3'].forEach(id => {
        bindEvents(document.getElementById(id), id);
    });

    // 2. ÂàùÂßãÊ∏≤ÊüìÊ†ºÂ≠ê
    renderCells('mainBoard', 8);
    renderCells('input1', 5); renderCells('input2', 5); renderCells('input3', 5);

    function renderCells(id, size) {
        const el = document.getElementById(id);
        el.innerHTML = ''; // Âè™Ê∏ÖÁ©∫Ê†ºÂ≠êÂÖßÂÆπÔºå‰∏çÂΩ±Èüø‰∫ã‰ª∂
        const total = size*size;
        for(let i=0; i<total; i++) {
            const d = document.createElement('div');
            d.className = 'cell'; d.dataset.i = i;
            el.appendChild(d);
        }
    }

    function bindEvents(el, id) {
        const start = (e) => {
            if(!e.target.classList.contains('cell')) return;
            if(e.cancelable && e.type === 'touchstart') e.preventDefault();
            isDrawing = true; currentDrawingId = id;
            const isMain = (id === 'mainBoard');
            const activeClass = isMain ? 'c-obs' : 'c-in';
            paintMode = !e.target.classList.contains(activeClass);
            paintCell(e.target, activeClass);
        };
        const move = (e) => {
            if(!isDrawing) return;
            if(e.cancelable) e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const target = document.elementFromPoint(clientX, clientY);
            if(target && target.classList.contains('cell') && target.parentElement.id === currentDrawingId) {
                const isMain = (currentDrawingId === 'mainBoard');
                const activeClass = isMain ? 'c-obs' : 'c-in';
                paintCell(target, activeClass);
            }
        };
        const end = () => { isDrawing = false; };
        el.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        el.addEventListener('touchstart', start, {passive: false}); window.addEventListener('touchmove', move, {passive: false}); window.addEventListener('touchend', end);
    }

    function paintCell(cell, cls) {
        if(paintMode) cell.classList.add(cls); else cell.classList.remove(cls);
    }

    function resetAll() {
        if(confirm('ÈáçÁΩÆÊâÄÊúâÂÖßÂÆπÔºü')) {
            renderCells('mainBoard', 8); renderCells('input1', 5); renderCells('input2', 5); renderCells('input3', 5);
            document.getElementById('resultArea').style.display = 'none';
            document.getElementById('msg').innerText = ''; finalBoardState = null;
        }
    }

    function continueGame() {
        if(!finalBoardState) return;
        renderCells('mainBoard', 8); // ÈáçÁπ™
        const cells = document.getElementById('mainBoard').children;
        for(let r=0; r<8; r++) { for(let c=0; c<8; c++) { if(finalBoardState[r][c]===1) cells[r*8+c].classList.add('c-obs'); } }
        renderCells('input1', 5); renderCells('input2', 5); renderCells('input3', 5); // ÂæπÂ∫ïÊ∏ÖÁ©∫ÊâãÁâå
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('msg').innerText = "‚úÖ Áõ§Èù¢Â∑≤Êõ¥Êñ∞ÔºåË´ãËº∏ÂÖ•‰∏ã‰∏ÄÊâã";
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    // --- AI V19 Êô∫ËÉΩÊ¨äÈáç (Anytime Clean Slate) ---
    function getBoard() {
        const cells = document.getElementById('mainBoard').children;
        let b = []; for(let i=0; i<8; i++) { let row=[]; for(let j=0; j<8; j++) row.push(cells[i*8+j].classList.contains('c-obs')?1:0); b.push(row); } return b;
    }
    function getShape(id, label) {
        const cells = document.getElementById(id).children;
        let pts=[]; for(let i=0; i<25; i++) if(cells[i].classList.contains('c-in')) pts.push({r:Math.floor(i/5), c:i%5});
        if(!pts.length) return null;
        const mr=Math.min(...pts.map(p=>p.r)), mc=Math.min(...pts.map(p=>p.c));
        return { pts: pts.map(p=>({r:p.r-mr, c:p.c-mc})), label: label };
    }
    function calculate() {
        const msg = document.getElementById('msg'); msg.innerText = "ÈÅãÁÆó‰∏≠...";
        const b = getBoard();
        const s1 = getShape('input1','1'), s2 = getShape('input2','2'), s3 = getShape('input3','3');
        if(!s1||!s2||!s3) { msg.innerText = "‚ö†Ô∏è Ë´ãÁï´ÂÆå 3 ÂÄãÊñπÂ°ä"; return; }

        setTimeout(() => {
            const perms = [[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]];
            let best = null;
            
            for(let order of perms) {
                // ÂÇ≥ÂÖ• false Ë°®Á§∫ÂàùÂßãÁãÄÊÖãÊ≤íÊ∏ÖÁ©∫
                const res = dfs(b, [s1,s2,s3], order, 0, [], 0, false);
                if(res) {
                    if(!best) best = res;
                    else {
                        if(getScore(res) > getScore(best)) best = res;
                    }
                }
            }
            if(best) {
                msg.innerText = ""; finalBoardState = best.history[2].board; showRes(b, best);
            } else {
                msg.innerText = "‚ùå ÁÑ°Ëß£"; document.getElementById('resultArea').style.display = 'none';
            }
        }, 50);
    }

    // Ë©ïÂàÜÁ≥ªÁµ±ÔºöÈáçË¶ñ„ÄåÊõæÁ∂ìÊ∏ÖÁ©∫„ÄçÁöÑÂÉπÂÄº (100Ëê¨ÂàÜ)
    function getScore(res) {
        let score = 0;
        if(res.everClean) score += 10000000;
        if(res.allClear) score += 100000;
        score += res.cleared * 10000; 
        score += res.space; 
        return score;
    }

    function dfs(board, shapes, order, idx, hist, totalCleared, everClean) {
        if(idx===3) {
            const space = board.flat().filter(x=>x===0).length;
            return { history: hist, cleared: totalCleared, space: space, allClear: space===64, everClean: everClean };
        }
        const s = shapes[order[idx]];
        let localBest = null;
        
        for(let r=0; r<8; r++) { for(let c=0; c<8; c++) {
            if(canPlace(board, s.pts, r, c)) {
                const next = place(board, s.pts, r, c);
                
                // Ê™¢Êü•ÈÄô‰∏ÄÊ≠•ÊòØÂê¶Â∞éËá¥ÂÖ®Ê∏Ö (Space=64)
                const currentSpace = next.b.flat().filter(x=>x===0).length;
                const isNowClean = (currentSpace === 64);
                // Âè™Ë¶ÅÊõæÁ∂ìÁôºÁîüÈÅéÂÖ®Ê∏ÖÔºåÂ∞±Ê®ôË®òËµ∑‰æÜ
                const newEverClean = everClean || isNowClean;

                const step = { board: next.b, move: {r,c,pts:s.pts}, label: s.label, cleared: next.n, isClean: isNowClean };
                const res = dfs(next.b, shapes, order, idx+1, [...hist, step], totalCleared+next.n, newEverClean);
                
                if(res) {
                    if(!localBest) localBest = res;
                    else {
                        if(getScore(res) > getScore(localBest)) localBest = res;
                    }
                }
            }
        }} return localBest;
    }
    
    function canPlace(b, pts, r, c) {
        for(let p of pts) { let nr=r+p.r, nc=c+p.c; if(nr>=8||nc>=8||b[nr][nc]===1) return false; } return true;
    }
    function place(b, pts, r, c) {
        let nb = b.map(row=>[...row]);
        for(let p of pts) nb[r+p.r][c+p.c]=1;
        let rows=[], cols=[];
        for(let i=0; i<8; i++) if(nb[i].every(x=>x===1)) rows.push(i);
        for(let j=0; j<8; j++) { let f=true; for(let i=0; i<8; i++) if(nb[i][j]===0) f=false; if(f) cols.push(j); }
        rows.forEach(i=>nb[i].fill(0)); cols.forEach(j=>{ for(let i=0; i<8; i++) nb[i][j]=0; });
        return { b: nb, n: rows.length+cols.length };
    }
    
    function showRes(initB, res) {
        document.getElementById('resultArea').style.display = 'block';
        const title = document.getElementById('resTitle');
        if(res.everClean) title.innerHTML = "üåü ÂÆåÁæéÊ∏ÖÁ©∫ (Clean Slate) <span class='perfect-badge'>PERFECT</span>";
        else if(res.cleared > 0) title.innerHTML = `‚úÖ Ê∂àÈô§ ${res.cleared} Ë°å`;
        else title.innerHTML = "üõ°Ô∏è ÂÆâÂÖ®ÊîæÁΩÆ";
        
        let cur = initB.map(row=>[...row]);
        const ids = ['res1','res2','res3'], tags = ['tag1','tag2','tag3'];
        res.history.forEach((h, i) => {
            document.getElementById(tags[i]).innerText = h.label; 
            const box = document.getElementById(ids[i]); box.innerHTML = '';
            for(let k=0; k<64; k++) {
                const d = document.createElement('div'); d.className='cell';
                if(cur[Math.floor(k/8)][k%8]===1) d.classList.add('c-obs');
                box.appendChild(d);
            }
            const cells = box.children, cls = `c-s${i+1}`;
            for(let p of h.move.pts) cells[(h.move.r+p.r)*8 + (h.move.c+p.c)].className = `cell ${cls}`;
            cur = h.board;
        });
        document.getElementById('resultArea').scrollIntoView({behavior:'smooth'});
    }
</script>
</body>
</html>