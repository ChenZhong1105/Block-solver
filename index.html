<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Solver V46 (Glow)</title>
    <style>
        :root {
            /* Dark (é è¨­) */
            --bg: #121212;
            --card: rgba(40, 40, 40, 0.85); /* ç¨å¾®åŠ æ·±ä¸€é»èƒŒæ™¯ */
            --txt: #ffffff;
            --sub: #a0a0a0;
            --border: rgba(255, 255, 255, 0.15);
            
            /* éŠæˆ²è‰² */
            --c-empty: rgba(255, 255, 255, 0.08);
            --c-obs: #4a90e2; 
            --c-in: #00d2d3;
            
            /* æŒ‰éˆ• */
            --btn: linear-gradient(135deg, #4a90e2, #00d2d3);
            --btn-txt: #ffffff;
            --btn-shadow: 0 4px 15px rgba(0, 210, 211, 0.4);
            
            /* æ­¥é©Ÿè‰² */
            --s1: #ff6b6b; --s2: #feca57; --s3: #48dbfb;
            
            /* è¨ˆç®—éµ */
            --calc-bg: #fff;
            --calc-txt: #000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg); color: var(--txt);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh; overflow: hidden;
            transition: background 0.4s ease;
        }

        /* è¦–åœ–å®¹å™¨ */
        .view-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; 
            overflow-y: auto; padding: 20px; padding-bottom: 150px;
            z-index: 10;
        }

        /* 1. èªè¨€é  */
        #view-lang { justify-content: center; z-index: 20; background: #000; }
        .lang-btn {
            width: 260px; padding: 18px; margin: 8px 0;
            background: rgba(255,255,255,0.1); 
            border: 1px solid var(--border); border-radius: 14px;
            color: #fff; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; gap: 15px;
            backdrop-filter: blur(10px);
        }
        .lang-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.98); }

        /* 2. ç™»å…¥é  */
        #view-login { justify-content: center; z-index: 15; }
        .logo { font-size: 2.2rem; font-weight: 900; margin-bottom: 50px; letter-spacing: 3px; }
        .theme-row { display: flex; gap: 30px; margin-bottom: 60px; }
        .t-dot { 
            width: 60px; height: 60px; border-radius: 50%; 
            border: 3px solid transparent; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .t-dot.active { border-color: var(--txt); transform: scale(1.2); box-shadow: 0 0 20px var(--txt); }
        
        .btn-start {
            padding: 16px 80px; border-radius: 50px; border: none;
            background: var(--btn); color: var(--btn-txt);
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: var(--btn-shadow); letter-spacing: 1px;
        }

        /* 3. ä¸»ç¨‹å¼ */
        #view-app { justify-content: flex-start; z-index: 10; }
        
        .card {
            width: 100%; max-width: 500px;
            background: var(--card); border: 1px solid var(--border);
            border-radius: 24px; padding: 20px; margin-bottom: 20px;
            backdrop-filter: blur(12px); box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .head-title { font-weight: 800; opacity: 0.9; font-size: 0.95rem; }
        .toggle-btn { background: none; border: none; color: var(--sub); font-size: 1.2rem; padding: 10px; transition: 0.3s; }
        .toggle-btn.rot { transform: rotate(180deg); }

        /* --- è¼¸å…¥ç¶²æ ¼ (ç¾åŒ–å›æ­¸) --- */
        .grid-input {
            display: grid; gap: 4px; 
            padding: 6px; background: rgba(0,0,0,0.2); 
            border-radius: 12px; margin: 0 auto;
        }
        .cell {
            background: var(--c-empty); 
            border-radius: 4px; /* åœ“è§’å›æ­¸ */
            cursor: pointer; transition: 0.1s;
        }
        /* â˜…â˜…â˜… éšœç¤™ç‰©ï¼šè—è‰²éœ“è™¹å…‰ â˜…â˜…â˜… */
        .c-obs { 
            background: var(--c-obs) !important; 
            box-shadow: 0 0 10px var(--c-obs); 
        }
        /* â˜…â˜…â˜… æ‰‹ç‰Œï¼šé’è‰²éœ“è™¹å…‰ + ç™½é‚Šæ¡† â˜…â˜…â˜… */
        .c-in { 
            background: var(--c-in) !important; 
            box-shadow: 0 0 10px var(--c-in); 
            border: 1px solid rgba(255,255,255,0.6); 
        }

        #board-main { grid-template-columns: repeat(8, 1fr); width: 100%; aspect-ratio: 1; max-width: 340px; }
        .mini-grid { grid-template-columns: repeat(5, 1fr); width: 125px; height: 125px; }
        .hand-area { display: flex; justify-content: center; gap: 10px; }

        /* çµæœå€ (JS æš´åŠ›é–æ­»ï¼Œä¸è®Š) */
        #res-section { display: none; margin-top: 25px; border-top: 1px solid var(--border); padding-top: 25px; text-align: center; }
        .res-row { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .res-item { display: flex; flex-direction: column; align-items: center; }
        
        /* åº•éƒ¨æ“ä½œ */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card); border-top: 1px solid var(--border);
            padding: 15px 20px; display: flex; gap: 15px; z-index: 1000;
            backdrop-filter: blur(20px);
            padding-bottom: max(15px, env(safe-area-inset-bottom));
        }
        .btn-act { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-act:active { transform: scale(0.96); }
        .btn-reset { background: rgba(255,255,255,0.05); color: var(--sub); border: 1px solid var(--border); }
        .btn-calc { background: var(--calc-bg); color: var(--calc-txt); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .btn-next { 
            width: 100%; margin-top: 20px; padding: 16px; border-radius: 12px; border: none;
            background: var(--btn); color: var(--btn-txt); font-size: 1.1rem; font-weight: bold;
            box-shadow: var(--btn-shadow); cursor: pointer; letter-spacing: 1px;
        }

        /* æ›è‰²æŒ‰éˆ• (Z-Index é ‚å¤©) */
        .fab { 
            position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; 
            border-radius: 50%; background: var(--card); border: 1px solid var(--border);
            display: flex; justify-content: center; align-items: center; font-size: 1.6rem; 
            z-index: 2147483647; cursor: pointer; box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }
        .menu { 
            position: fixed; bottom: 170px; right: 20px; 
            background: rgba(20,20,20,0.95); padding: 15px; border-radius: 50px; 
            display: none; gap: 15px; z-index: 2147483647; 
            border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .m-dot { width: 34px; height: 34px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.3); transition: 0.2s; }
        .m-dot:active { transform: scale(1.2); border-color: #fff; }

        /* æ•™å­¸ */
        #modal-tut { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 90000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .tut-box { background: var(--card); width: 85%; max-width: 340px; padding: 35px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        
        .hide { display: none !important; }
        #status { text-align: center; height: 24px; margin-top: 15px; color: var(--s2); font-weight: bold; letter-spacing: 1px; }
        .tag { background: linear-gradient(45deg, #ff0055, #ffaa00); color: #fff; padding: 3px 10px; border-radius: 6px; font-size: 0.8rem; margin-left: 6px; box-shadow: 0 2px 10px rgba(255,0,0,0.3); }
    </style>
</head>
<body data-theme="dark">

<div id="view-lang" class="view-container" style="display:flex;">
    <h2 style="color:var(--txt); margin-bottom:40px; font-weight:800;">SELECT LANGUAGE</h2>
    <div class="lang-btn" onclick="setLang('zh')"><span style="font-size:1.5rem">ğŸ‡¹ğŸ‡¼</span> ç¹é«”ä¸­æ–‡</div>
    <div class="lang-btn" onclick="setLang('jp')"><span style="font-size:1.5rem">ğŸ‡¯ğŸ‡µ</span> æ—¥æœ¬èª</div>
    <div class="lang-btn" onclick="setLang('kr')"><span style="font-size:1.5rem">ğŸ‡°ğŸ‡·</span> í•œêµ­ì–´</div>
    <div class="lang-btn" onclick="setLang('en')"><span style="font-size:1.5rem">ğŸ‡ºğŸ‡¸</span> English</div>
    <div class="lang-btn" onclick="setLang('es')"><span style="font-size:1.5rem">ğŸ‡ªğŸ‡¸</span> EspaÃ±ol</div>
</div>

<div id="view-login" class="view-container">
    <div class="logo" id="t-logo">BLOCK SOLVER</div>
    <div class="theme-row">
        <div class="t-dot active" style="background:linear-gradient(135deg,#2c3e50,#1a1a1a); color:#3b82f6" onclick="setTheme('dark', this)"></div>
        <div class="t-dot" style="background:linear-gradient(135deg,#ff9a9e,#fad0c4); color:#ff9a9e" onclick="setTheme('light', this)"></div>
        <div class="t-dot" style="background:linear-gradient(135deg,#bf953f,#fcf6ba); color:#ffd700" onclick="setTheme('gold', this)"></div>
    </div>
    <button class="btn-start" id="t-start" onclick="goApp()">START</button>
</div>

<div id="view-app" class="view-container">
    <div class="card">
        <div class="head">
            <span id="t-board" class="head-title">BOARD</span>
            <button class="toggle-btn" onclick="document.getElementById('wrap-board').classList.toggle('hide'); this.classList.toggle('rot');">â–¼</button>
        </div>
        <div id="wrap-board">
            <div id="board-main" class="grid-input"></div>
        </div>
    </div>

    <div class="card">
        <div class="head"><span id="t-hand" class="head-title">HAND</span></div>
        <div class="hand-area">
            <div class="hand-wrap"><div id="h1" class="grid-input mini-grid" data-id="1"></div></div>
            <div class="hand-wrap"><div id="h2" class="grid-input mini-grid" data-id="2"></div></div>
            <div class="hand-wrap"><div id="h3" class="grid-input mini-grid" data-id="3"></div></div>
        </div>
        <div id="status"></div>

        <div id="res-section">
            <div id="t-res" style="margin-bottom:20px; font-weight:800; letter-spacing:1px;">RESULT</div>
            <div class="res-row">
                <div class="res-item"><div style="color:var(--s1); margin-bottom:8px; font-weight:bold;">1</div><div id="r1"></div></div>
                <div class="res-item"><div style="color:var(--s2); margin-bottom:8px; font-weight:bold;">2</div><div id="r2"></div></div>
                <div class="res-item"><div style="color:var(--s3); margin-bottom:8px; font-weight:bold;">3</div><div id="r3"></div></div>
            </div>
            <button id="t-next" class="btn-next" onclick="nextRound()">NEXT ROUND</button>
        </div>
    </div>
</div>

<div class="fab" onclick="toggleMenu()">âœ¨</div>
<div id="menu" class="menu">
    <div class="m-dot" style="background:#3b82f6" onclick="setAppTheme('dark')"></div>
    <div class="m-dot" style="background:#ff9a9e" onclick="setAppTheme('light')"></div>
    <div class="m-dot" style="background:#ffd700" onclick="setAppTheme('gold')"></div>
</div>

<div id="bar" class="bottom-bar hide">
    <button id="t-reset" class="btn-act btn-reset" onclick="resetAll()">RESET</button>
    <button id="t-calc" class="btn-act btn-calc" onclick="calc()">CALC</button>
</div>

<div id="modal-tut">
    <div class="tut-box">
        <h2 id="t-guide" style="margin-top:0; text-align:center;">GUIDE</h2>
        <ul style="padding-left:20px; line-height:2.2; color:var(--sub); font-size:1rem;">
            <li id="l1"></li><li id="l2"></li><li id="l3"></li><li id="l4"></li>
        </ul>
        <button id="t-ok" class="btn-next" style="margin-top:25px;" onclick="document.getElementById('modal-tut').style.display='none'">OK</button>
    </div>
</div>

<script>
    const DB = {
        zh: { logo:"æ–¹å¡Šæ”»ç•¥", start:"é€²å…¥ç³»çµ±", board:"ç›¤é¢è¨­å®š", hand:"æ‰‹ç‰Œè¼¸å…¥", reset:"æ¸…ç©º", calc:"é–‹å§‹è¨ˆç®—", next:"å¥—ç”¨ä¸¦å‰å¾€ä¸‹ä¸€å±€", ready:"æº–å‚™å°±ç·’", err:"è«‹ç•«å®Œ 3 å€‹æ‰‹ç‰Œ", ok:"ç›¤é¢å·²æ›´æ–°", no:"ç„¡è§£", perf:"å®Œç¾æ¸…ç©º", elim:"æ¶ˆé™¤", guide:"æˆ°ç•¥æŒ‡å—", s1:"æ¨™è¨˜éšœç¤™ç‰©", s2:"ç•«å‡ºæ‰‹ç‰Œ", s3:"é»æ“Šè¨ˆç®—", s4:"é»æ“Šä¸‹ä¸€å±€", okbtn:"é–‹å§‹ä½¿ç”¨", res:"æœ€ä½³ç­–ç•¥" },
        jp: { logo:"æ”»ç•¥ãƒ„ãƒ¼ãƒ«", start:"ã‚¹ã‚¿ãƒ¼ãƒˆ", board:"ç›¤é¢è¨­å®š", hand:"æ‰‹æŒã¡", reset:"ãƒªã‚»ãƒƒãƒˆ", calc:"è¨ˆç®—é–‹å§‹", next:"é©ç”¨ã—ã¦æ¬¡ã¸", ready:"æº–å‚™å®Œäº†", err:"3ã¤å…¨ã¦æã„ã¦", ok:"æ›´æ–°å®Œäº†", no:"è§£ãªã—", perf:"å®Œå…¨æ¶ˆå»", elim:"æ¶ˆå»", guide:"ä½¿ã„æ–¹", s1:"éšœå®³ç‰©ã‚’ãƒãƒ¼ã‚¯", s2:"æ‰‹æŒã¡ã‚’æã", s3:"è¨ˆç®—ã‚’æŠ¼ã™", s4:"æ¬¡ã¸ã‚’æŠ¼ã™", okbtn:"å§‹ã‚ã‚‹", res:"çµæœ" },
        kr: { logo:"ë¸”ë¡ ì†”ë²„", start:"ì‹œì‘", board:"ë³´ë“œ ì„¤ì •", hand:"ë¸”ë¡ ì…ë ¥", reset:"ì´ˆê¸°í™”", calc:"ê³„ì‚° ì‹œì‘", next:"ì ìš© ë° ë‹¤ìŒ", ready:"ì¤€ë¹„ ì™„ë£Œ", err:"3ê°œ ëª¨ë‘ ê·¸ë ¤ì£¼ì„¸ìš”", ok:"ì—…ë°ì´íŠ¸ ì™„ë£Œ", no:"í•´ê²° ë¶ˆê°€", perf:"í¼í™íŠ¸", elim:"ì œê±°", guide:"ì‚¬ìš©ë²•", s1:"ì¥ì• ë¬¼ í‘œì‹œ", s2:"ë¸”ë¡ ê·¸ë¦¬ê¸°", s3:"ê³„ì‚° í´ë¦­", s4:"ë‹¤ìŒ í´ë¦­", okbtn:"í™•ì¸", res:"ê²°ê³¼" },
        en: { logo:"BLOCK SOLVER", start:"START", board:"BOARD", hand:"HAND", reset:"RESET", calc:"CALCULATE", next:"APPLY & NEXT", ready:"Ready", err:"Draw 3 blocks", ok:"Updated", no:"No Solution", perf:"Perfect Clear", elim:"Lines", guide:"Guide", s1:"Mark obstacles", s2:"Draw hands", s3:"Click Calculate", s4:"Click Next", okbtn:"Got it", res:"RESULT" },
        es: { logo:"SOLUCIONADOR", start:"INICIAR", board:"TABLERO", hand:"MANO", reset:"REINICIAR", calc:"CALCULAR", next:"SIGUIENTE", ready:"Listo", err:"Dibuja 3 bloques", ok:"Actualizado", no:"Sin soluciÃ³n", perf:"Perfecto", elim:"LÃ­neas", guide:"GuÃ­a", s1:"Marcar obstÃ¡culos", s2:"Dibujar manos", s3:"Calcular", s4:"Siguiente", okbtn:"Entendido", res:"RESULTADO" }
    };
    let LANG = 'zh';

    const THEMES = {
        dark: { bgGrad:'linear-gradient(135deg, #1a1a1a, #000)', card:'rgba(40,40,40,0.85)', txt:'#fff', sub:'#a0a0a0', border:'rgba(255,255,255,0.15)', empty:'rgba(255,255,255,0.08)', obs:'#4a90e2', in:'#00d2d3', btn:'linear-gradient(135deg, #4a90e2, #00d2d3)', btnTxt:'#fff', shadow:'0 5px 15px rgba(0,210,211,0.4)', cBg:'#fff', cTxt:'#000' },
        light: { bgGrad:'linear-gradient(135deg, #fff0f5, #ffeef2)', card:'rgba(255,255,255,0.9)', txt:'#2d3436', sub:'#636e72', border:'rgba(255,182,193,0.4)', empty:'rgba(0,0,0,0.05)', obs:'#ff7675', in:'#ff9ff3', btn:'linear-gradient(135deg, #ff758c, #ff7eb3)', btnTxt:'#fff', shadow:'0 5px 15px rgba(255,118,117,0.4)', cBg:'#ff6b81', cTxt:'#fff' },
        gold: { bgGrad:'linear-gradient(135deg, #000, #111)', card:'rgba(25,25,25,0.95)', txt:'#ffd700', sub:'#b8860b', border:'rgba(255,215,0,0.3)', empty:'rgba(255,215,0,0.08)', obs:'#ffd700', in:'#fff', btn:'linear-gradient(135deg, #b8860b, #ffd700)', btnTxt:'#000', shadow:'0 5px 20px rgba(255,215,0,0.3)', cBg:'#ffd700', cTxt:'#000' }
    };

    function showView(id) {
        document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'flex';
    }

    function setLang(l) {
        LANG = l; const t = DB[LANG];
        const map = { 't-logo':'logo', 't-start':'start', 't-board':'board', 't-hand':'hand', 't-reset':'reset', 't-calc':'calc', 't-next':'next', 't-guide':'guide', 'l1':'s1', 'l2':'s2', 'l3':'s3', 'l4':'s4', 't-ok':'okbtn', 't-res':'res' };
        for(let k in map) { const el=document.getElementById(k); if(el) el.innerText=t[map[k]]; }
        document.getElementById('status').innerText=t.ready;
        showView('view-login');
    }

    function setTheme(t, el) {
        document.querySelectorAll('.t-dot').forEach(d=>d.classList.remove('active'));
        if(el) el.classList.add('active');
        setAppTheme(t);
    }

    function setAppTheme(t) {
        const v = THEMES[t]; const r = document.documentElement.style;
        r.setProperty('--bg', v.bgGrad); r.setProperty('--card', v.card); r.setProperty('--txt', v.txt);
        r.setProperty('--sub', v.sub); r.setProperty('--border', v.border); r.setProperty('--c-empty', v.empty);
        r.setProperty('--c-obs', v.obs); r.setProperty('--c-in', v.in); r.setProperty('--btn', v.btn);
        r.setProperty('--btn-txt', v.btnTxt); r.setProperty('--btn-shadow', v.shadow);
        r.setProperty('--calc-bg', v.cBg); r.setProperty('--calc-txt', v.cTxt);
        document.body.setAttribute('data-theme', t);
        document.getElementById('menu').style.display = 'none';
    }

    function goApp() {
        showView('view-app');
        document.getElementById('bar').classList.remove('hide');
        document.getElementById('modal-tut').style.display = 'flex';
    }
    
    function toggleMenu() { 
        const m = document.getElementById('menu');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    }

    function createGrid(id, size) {
        const el = document.getElementById(id); el.innerHTML = '';
        for(let i=0; i<size*size; i++) {
            const d = document.createElement('div');
            d.className = 'cell'; d.dataset.i=i; el.appendChild(d);
        }
        bindTouch(el, id);
    }
    createGrid('board-main', 8); createGrid('h1', 5); createGrid('h2', 5); createGrid('h3', 5);

    let isDraw=false, mode=true, currId=null;
    function bindTouch(el, id) {
        const start = (e) => {
            if(!e.target.classList.contains('cell')) return;
            if(e.cancelable) e.preventDefault();
            isDraw=true; currId=id;
            const cls = (id==='board-main' ? 'c-obs' : 'c-in');
            mode = !e.target.classList.contains(cls);
            paint(e.target, cls);
        };
        const move = (e) => {
            if(!isDraw) return;
            if(e.cancelable) e.preventDefault();
            const t = document.elementFromPoint(e.touches?e.touches[0].clientX:e.clientX, e.touches?e.touches[0].clientY:e.clientY);
            if(t && t.classList.contains('cell') && t.parentElement.id===currId) paint(t, (currId==='board-main'?'c-obs':'c-in'));
        };
        const end = () => isDraw=false;
        el.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        el.addEventListener('touchstart', start, {passive:false}); window.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    }
    function paint(el, cls) { if(mode) el.classList.add(cls); else el.classList.remove(cls); }

    let finalState = null;
    function resetAll() {
        if(!confirm('Reset?')) return;
        document.querySelectorAll('.cell').forEach(c => { c.classList.remove('c-obs'); c.classList.remove('c-in'); });
        document.getElementById('res-section').style.display='none';
        document.getElementById('status').innerText = DB[LANG].ready;
        finalState = null;
    }
    function nextRound() {
        if(!finalState) return;
        const cs = document.getElementById('board-main').children;
        for(let i=0; i<64; i++) {
            const r=Math.floor(i/8), c=i%8;
            cs[i].className='cell';
            if(finalState[r][c]===1) cs[i].classList.add('c-obs');
        }
        ['h1','h2','h3'].forEach(id=>{ Array.from(document.getElementById(id).children).forEach(c=>c.classList.remove('c-in')) });
        document.getElementById('res-section').style.display='none';
        document.getElementById('status').innerText = DB[LANG].ok;
        window.scrollTo({top:0, behavior:'smooth'});
    }
    function getB() {
        const cs = document.getElementById('board-main').children;
        let b=[]; for(let i=0; i<8; i++) { let r=[]; for(let j=0; j<8; j++) r.push(cs[i*8+j].classList.contains('c-obs')?1:0); b.push(r); } return b;
    }
    function getS(id, l) {
        const cs = document.getElementById(id).children;
        let pts=[]; for(let i=0; i<25; i++) if(cs[i].classList.contains('c-in')) pts.push({r:Math.floor(i/5), c:i%5});
        if(!pts.length) return null;
        const mr=Math.min(...pts.map(p=>p.r)), mc=Math.min(...pts.map(p=>p.c));
        return { pts: pts.map(p=>({r:p.r-mr, c:p.c-mc})), l:l };
    }
    function calc() {
        const st = document.getElementById('status'); st.innerText = "Running...";
        const b = getB(); const s1=getS('h1','1'), s2=getS('h2','2'), s3=getS('h3','3');
        if(!s1||!s2||!s3) { st.innerText = DB[LANG].err; return; }
        setTimeout(() => {
            const ords = [[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]];
            let best = null;
            for(let o of ords) {
                const res = dfs(b, [s1,s2,s3], o, 0, [], 0, false, -1);
                if(res) { if(!best || getScore(res) > getScore(best)) best = res; }
            }
            if(best) {
                st.innerText = ""; finalState = best.hist[2].board; renderRes(b, best);
            } else {
                st.innerText = DB[LANG].no; document.getElementById('res-section').style.display='none';
            }
        }, 50);
    }
    function getScore(r) { let s=0; if(r.fc!==-1) s+=(5-r.fc)*90000000; s+=r.clr*10000; s+=r.spc; return s; }
    function dfs(b, shapes, order, idx, hist, clr, ec, fc) {
        if(idx===3) { return { hist:hist, clr:clr, spc:b.flat().filter(x=>x===0).length, ec:ec, fc:fc }; }
        const s = shapes[order[idx]]; let localBest = null;
        for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
            if(can(b, s.pts, r, c)) {
                const next = put(b, s.pts, r, c);
                const isCln = (next.b.flat().filter(x=>x===0).length === 64);
                const nFc = (isCln && fc===-1) ? idx : fc;
                const res = dfs(next.b, shapes, order, idx+1, [...hist, {board:next.b, move:{r,c,pts:s.pts}, l:s.l}], clr+next.n, ec||isCln, nFc);
                if(res) { if(!localBest || getScore(res) > getScore(localBest)) localBest = res; }
            }
        }
        return localBest;
    }
    function can(b, pts, r, c) { for(let p of pts) { let nr=r+p.r, nc=c+p.c; if(nr>=8||nc>=8||b[nr][nc]) return false; } return true; }
    function put(b, pts, r, c) {
        let nb = b.map(row=>[...row]); for(let p of pts) nb[r+p.r][c+p.c] = 1;
        let rows=[], cols=[];
        for(let i=0; i<8; i++) if(nb[i].every(x=>x===1)) rows.push(i);
        for(let j=0; j<8; j++) { let f=true; for(let i=0; i<8; i++) if(nb[i][j]===0) f=false; if(f) cols.push(j); }
        rows.forEach(i=>nb[i].fill(0)); cols.forEach(j=>{ for(let i=0; i<8; i++) nb[i][j]=0; });
        return { b:nb, n:rows.length+cols.length };
    }

    // --- æš´åŠ›ç¹ªè£½çµæœ (Inline Styles) ---
    function renderRes(initB, res) {
        document.getElementById('res-section').style.display='block';
        const t = DB[LANG]; const tit = document.getElementById('t-res');
        if(res.ec) tit.innerHTML = `${t.perf} <span class='tag'>PERFECT</span>`;
        else if(res.clr>0) tit.innerText = `${t.elim}: ${res.clr}`;
        else tit.innerText = "SAFE";

        let cur = JSON.parse(JSON.stringify(initB));
        const ids = ['r1','r2','r3'];
        const cols = ['#ff6b6b', '#feca57', '#48dbfb']; // ä½¿ç”¨ç´”è‰²ï¼Œé¿å…ç€è¦½å™¨ç›¸å®¹å•é¡Œ
        const obsC = getComputedStyle(document.documentElement).getPropertyValue('--c-obs').trim();

        res.hist.forEach((h, i) => {
            const box = document.getElementById(ids[i]); box.innerHTML = '';
            
            // â˜…â˜…â˜… å¼·åˆ¶å®šç¾©å®¹å™¨ (Grid Lock) â˜…â˜…â˜…
            box.style.display = 'grid';
            box.style.gridTemplateColumns = 'repeat(8, 20px)';
            box.style.gridTemplateRows = 'repeat(8, 20px)';
            box.style.width = 'max-content'; /* é—œéµä¿®æ­£ */
            box.style.background = '#000';
            box.style.gap = '0';
            box.style.padding = '0';
            box.style.border = '2px solid rgba(255,255,255,0.2)';
            box.style.borderRadius = '4px';
            box.style.overflow = 'hidden';

            for(let k=0; k<64; k++) {
                const d = document.createElement('div');
                // æ ¼å­æ¨£å¼
                d.style.width = '20px';
                d.style.height = '20px';
                d.style.boxSizing = 'border-box';
                d.style.margin = '0';
                d.style.borderRadius = '2px';
                
                const r = Math.floor(k/8), c = k%8;
                let isP = false;
                for(let p of h.move.pts) { if((h.move.r+p.r)===r && (h.move.c+p.c)===c) { isP = true; break; } }
                
                if(isP) {
                    d.style.backgroundColor = cols[i];
                    d.style.boxShadow = "inset 0 0 0 1px rgba(255,255,255,0.4)"; // é‚Šæ¡†æ”¹ç”¨å…§é™°å½±
                } else if(cur[r][c]===1) {
                    d.style.backgroundColor = obsC;
                    d.style.opacity = "0.6";
                } else {
                    d.style.backgroundColor = "#222";
                    d.style.boxShadow = "inset 0 0 0 1px rgba(255,255,255,0.05)";
                }
                box.appendChild(d);
            }
            cur = JSON.parse(JSON.stringify(h.board));
        });
        document.getElementById('res-section').scrollIntoView({behavior:'smooth'});
    }
</script>
</body>
</html>